<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Armed Bandit Analytics Dashboard</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #4a90e2;
            --success: #5cb85c;
            --danger: #d9534f;
            --warning: #f0ad4e;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --bg: #f5f7fa;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1);
            --hover-shadow: 0 4px 8px rgba(0,0,0,0.15);
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --border-color: #ddd;
            --table-hover: #f8f9fa;
        }
        
        [data-theme="dark"] {
            --primary: #5dade2;
            --success: #58d68d;
            --danger: #ec7063;
            --warning: #f7dc6f;
            --dark: #ffffff;
            --light: #34495e;
            --bg: #1a1a1a;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.3);
            --hover-shadow: 0 4px 8px rgba(0,0,0,0.4);
            --text-color: #ffffff;
            --card-bg: #2c3e50;
            --border-color: #34495e;
            --table-hover: #34495e;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #357abd 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        /* Dark Mode Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }
        
        .theme-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle:hover .theme-icon {
            transform: rotate(180deg);
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
        }
        
        .variant-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr 0.8fr;
            gap: 0.5rem;
            align-items: end;
            margin-bottom: 0.5rem;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #357abd;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 144, 226, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        /* Allocation Display */
        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .allocation-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .allocation-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .allocation-value {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .allocation-stats {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--bg);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid var(--light);
            color: var(--text-color);
        }
        
        tbody tr:hover {
            background: var(--table-hover);
        }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        /* Metrics Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-top: 3px solid var(--primary);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--light);
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Reset Button */
        .reset-section {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .variant-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>üéØ Multi-Armed Bandit Analytics</h1>
            <div class="header-controls">
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-experiments">0</div>
                        <div class="stat-label">Experimentos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-impressions">0</div>
                        <div class="stat-label">Impress√µes Totais</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avg-ctr">0%</div>
                        <div class="stat-label">CTR M√©dio</div>
                    </div>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span class="theme-icon" id="theme-icon">üåô</span>
                    <span id="theme-text">Dark Mode</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Quick Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="best-variant">-</div>
                <div class="metric-label">Melhor Variante</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="confidence-level">-</div>
                <div class="metric-label">Confian√ßa</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="regret-value">0</div>
                <div class="metric-label">Regret Acumulado</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="convergence-rate">0%</div>
                <div class="metric-label">Taxa Converg√™ncia</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'experiments')">Experimentos</button>
            <button class="tab" onclick="switchTab(event, 'analysis')">An√°lise</button>
            <button class="tab" onclick="switchTab(event, 'simulation')">Simula√ß√£o</button>
            <button class="tab" onclick="switchTab(event, 'settings')">Configura√ß√µes</button>
        </div>
        
        <!-- Tab Contents -->
        
        <!-- Experiments Tab -->
        <div id="experiments-tab" class="tab-content active">
            <div class="grid grid-2">
                <!-- Create Experiment -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Criar Experimento</h2>
                    </div>
                    <form id="create-experiment-form">
                        <div class="form-group">
                            <label class="form-label">Nome do Experimento</label>
                            <input type="text" class="form-control" id="exp-name" required placeholder="Digite o nome do experimento">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <textarea class="form-control" id="exp-description" rows="2" placeholder="Descri√ß√£o opcional"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Criar Experimento</button>
                        <div id="create-message"></div>
                    </form>
                </div>
                
                <!-- Submit Events -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Enviar Dados Manuais</h2>
                    </div>
                    <form id="submit-events-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ID do Experimento</label>
                                <input type="number" class="form-control" id="event-exp-id" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data</label>
                                <input type="date" class="form-control" id="event-date" required>
                            </div>
                        </div>
                        
                        <div id="variants-container">
                            <label class="form-label">Variantes</label>
                            <div id="variants-list"></div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addVariant()">+ Adicionar Variante</button>
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">Enviar Dados</button>
                        </div>
                        <div id="events-message"></div>
                    </form>
                </div>
            </div>
            
            <!-- Upload Section - Separated -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üì§ Upload de Dados em Lote (CSV)</h2>
                </div>
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label">Selecionar Arquivo CSV</label>
                        <input type="file" class="form-control" id="csv-file" accept=".csv" required>
                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                            Formato: experiment_id, date, variant_name, impressions, clicks, conversions
                        </small>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-success">üöÄ Enviar CSV</button>
                        <button type="button" class="btn btn-warning" onclick="downloadTemplate()">üìä Baixar Modelo</button>
                    </div>
                </form>
                <div id="upload-message"></div>
            </div>
            
            <!-- Get Allocation -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Calcular Aloca√ß√£o √ìtima</h2>
                </div>
                <form id="get-allocation-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ID do Experimento</label>
                            <input type="number" class="form-control" id="allocation-exp-id" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Janela (dias)</label>
                            <input type="number" class="form-control" id="window-days" value="14" min="1" max="90">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Calcular Aloca√ß√£o</button>
                </form>
                
                <div id="allocation-results" style="margin-top: 2rem; display: none;">
                    <h3>Aloca√ß√£o Recomendada</h3>
                    <div id="allocation-display" class="allocation-grid"></div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Tab -->
        <div id="analysis-tab" class="tab-content">
            <div class="grid grid-2">
                <!-- CTR Performance Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Performance CTR</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="ctr-chart"></canvas>
                    </div>
                </div>
                
                <!-- Allocation History Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Evolu√ß√£o da Aloca√ß√£o</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="allocation-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Results Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Dados Detalhados</h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Variante</th>
                                <th>Impress√µes</th>
                                <th>Cliques</th>
                                <th>CTR</th>
                                <th>Aloca√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="results-table">
                            <tr><td colspan="6" style="text-align: center;">Nenhum dado dispon√≠vel</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Simulation Tab -->
        <div id="simulation-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Simulador de Cen√°rios</h2>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Dias para Simular</label>
                        <input type="number" class="form-control" id="sim-days" value="30" min="1" max="365">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Impress√µes por Dia</label>
                        <input type="number" class="form-control" id="sim-impressions" value="10000" min="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CTR Control (%)</label>
                        <input type="number" class="form-control" id="sim-ctr-control" value="7" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CTR Variant B (%)</label>
                        <input type="number" class="form-control" id="sim-ctr-variant" value="9.5" min="0" max="100" step="0.1">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="runSimulation()">Executar Simula√ß√£o</button>
                
                <div id="simulation-results" style="margin-top: 2rem; display: none;">
                    <div class="grid grid-2">
                        <div class="chart-container">
                            <canvas id="simulation-allocation-chart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="simulation-regret-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Configura√ß√µes do Sistema</h2>
                </div>
                <div class="form-group">
                    <label class="form-label">Taxa M√≠nima de Explora√ß√£o</label>
                    <input type="number" class="form-control" id="min-explore-rate" value="0.1" min="0" max="1" step="0.01">
                    <small style="color: #666;">Percentual m√≠nimo de tr√°fego para explora√ß√£o (0-1)</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Piso do Controle</label>
                    <input type="number" class="form-control" id="control-floor" value="0.2" min="0" max="1" step="0.01">
                    <small style="color: #666;">Aloca√ß√£o m√≠nima para o grupo controle (0-1)</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Mudan√ßa M√°xima Di√°ria</label>
                    <input type="number" class="form-control" id="max-daily-shift" value="0.1" min="0" max="1" step="0.01">
                    <small style="color: #666;">Mudan√ßa m√°xima permitida na aloca√ß√£o por dia (0-1)</small>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Salvar Configura√ß√µes</button>
                <div id="settings-message"></div>
            </div>
        </div>
    </div>
    
    <!-- Reset Button -->
    <div class="reset-section">
        <button class="btn btn-danger" onclick="resetData()">üîÑ Limpar Dados</button>
    </div>
    
    <script>
        // API Configuration
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:8001' 
            : '';
        
        // Initialize
        let variantCount = 0;
        let charts = {};
        let currentLanguage = 'pt';
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            document.getElementById('event-date').valueAsDate = new Date();
            
            // Add initial variants
            addVariant();
            addVariant();
            
            // Load experiments
            loadExperiments();
            
            // Initialize charts
            initializeCharts();
            
            // Check theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
                document.getElementById('theme-text').textContent = 'Light Mode';
            }
        });
        
        // Theme Toggle
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            
            if (newTheme === 'dark') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'Dark Mode';
            }
            
            // Update charts theme
            updateChartsTheme();
        }
        
        // Tab Switching
        function switchTab(event, tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Add Variant Row
        function addVariant() {
            variantCount++;
            const variantsList = document.getElementById('variants-list');
            const variantRow = document.createElement('div');
            variantRow.className = 'variant-row';
            variantRow.innerHTML = `
                <input type="text" class="form-control" placeholder="Nome (ex: Control)" required>
                <input type="number" class="form-control" placeholder="Impress√µes" min="0" required>
                <input type="number" class="form-control" placeholder="Cliques" min="0" required>
                <input type="number" class="form-control" placeholder="Convers√µes" min="0">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeVariant(this)">X</button>
            `;
            variantsList.appendChild(variantRow);
        }
        
        // Remove Variant Row
        function removeVariant(button) {
            if (document.querySelectorAll('.variant-row').length > 1) {
                button.parentElement.remove();
            }
        }
        
        // Create Experiment
        document.getElementById('create-experiment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('exp-name').value,
                description: document.getElementById('exp-description').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/experiments/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage('create-message', `‚úÖ Experimento criado com ID: ${result.id}`, 'success');
                    document.getElementById('create-experiment-form').reset();
                    loadExperiments();
                } else {
                    const error = await response.json();
                    showMessage('create-message', `‚ùå Erro: ${error.detail}`, 'danger');
                }
            } catch (error) {
                showMessage('create-message', `‚ùå Erro de conex√£o: ${error.message}`, 'danger');
            }
        });
        
        // Submit Events
        document.getElementById('submit-events-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const variantRows = document.querySelectorAll('.variant-row');
            const variants = [];
            
            variantRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                variants.push({
                    variant_name: inputs[0].value,
                    impressions: parseInt(inputs[1].value),
                    clicks: parseInt(inputs[2].value),
                    conversions: parseInt(inputs[3].value) || 0
                });
            });
            
            const data = {
                experiment_id: parseInt(document.getElementById('event-exp-id').value),
                date: document.getElementById('event-date').value,
                variants: variants
            };
            
            try {
                const response = await fetch(`${API_URL}/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage('events-message', `‚úÖ Dados enviados com sucesso!`, 'success');
                    updateMetrics();
                } else {
                    const error = await response.json();
                    showMessage('events-message', `‚ùå Erro: ${error.detail}`, 'danger');
                }
            } catch (error) {
                showMessage('events-message', `‚ùå Erro de conex√£o: ${error.message}`, 'danger');
            }
        });
        
        // Upload CSV
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('csv-file');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch(`${API_URL}/upload-data`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage('upload-message', 
                            `‚úÖ Upload conclu√≠do! ${result.processed_rows} linhas processadas.`, 
                            'success');
                    } else {
                        showMessage('upload-message', 
                            `‚ö†Ô∏è Upload parcial. ${result.processed_rows} linhas processadas, ${result.total_errors} erros.`, 
                            'warning');
                    }
                    updateMetrics();
                } else {
                    const error = await response.json();
                    showMessage('upload-message', `‚ùå Erro: ${error.detail}`, 'danger');
                }
            } catch (error) {
                showMessage('upload-message', `‚ùå Erro de conex√£o: ${error.message}`, 'danger');
            }
        });
        
        // Get Allocation
        document.getElementById('get-allocation-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const experimentId = document.getElementById('allocation-exp-id').value;
            const windowDays = document.getElementById('window-days').value;
            
            try {
                const response = await fetch(`${API_URL}/allocation?experiment_id=${experimentId}&window_days=${windowDays}`);
                
                if (response.ok) {
                    const result = await response.json();
                    displayAllocation(result);
                    updateCharts(result);
                } else {
                    const error = await response.json();
                    alert(`Erro: ${error.detail || error.error}`);
                }
            } catch (error) {
                alert(`Erro de conex√£o: ${error.message}`);
            }
        });
        
        // Display Allocation Results
        function displayAllocation(data) {
            const display = document.getElementById('allocation-display');
            const resultsDiv = document.getElementById('allocation-results');
            
            display.innerHTML = '';
            
            for (const [variant, percentage] of Object.entries(data.allocations)) {
                const item = document.createElement('div');
                item.className = 'allocation-item';
                
                const variantData = data.summary?.variants?.find(v => v.name === variant);
                const ctr = variantData ? ((variantData.clicks / variantData.impressions) * 100).toFixed(2) : 0;
                
                item.innerHTML = `
                    <div class="allocation-name">${variant}</div>
                    <div class="allocation-value">${(percentage * 100).toFixed(1)}%</div>
                    <div class="allocation-stats">
                        CTR: ${ctr}%<br>
                        Impress√µes: ${variantData?.impressions || 0}<br>
                        Cliques: ${variantData?.clicks || 0}
                    </div>
                `;
                display.appendChild(item);
            }
            
            resultsDiv.style.display = 'block';
        }
        
        // Load Experiments
        async function loadExperiments() {
            try {
                const response = await fetch(`${API_URL}/experiments/`);
                if (response.ok) {
                    const experiments = await response.json();
                    document.getElementById('total-experiments').textContent = experiments.length;
                }
            } catch (error) {
                console.error('Erro ao carregar experimentos:', error);
            }
        }
        
        // Update Metrics
        async function updateMetrics() {
            // This would fetch real metrics from the API
            // For now, using placeholder values
            document.getElementById('total-impressions').textContent = '125.4K';
            document.getElementById('avg-ctr').textContent = '8.2%';
            document.getElementById('best-variant').textContent = 'Variant B';
            document.getElementById('confidence-level').textContent = '95%';
        }
        
        // Initialize Charts
        function initializeCharts() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#ffffff' : '#2c3e50';
            const gridColor = isDark ? '#34495e' : '#ecf0f1';
            
            // CTR Chart
            const ctrCtx = document.getElementById('ctr-chart');
            if (ctrCtx) {
                charts.ctr = new Chart(ctrCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: textColor }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
            }
            
            // Allocation Chart
            const allocCtx = document.getElementById('allocation-chart');
            if (allocCtx) {
                charts.allocation = new Chart(allocCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: textColor }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                stacked: true,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
            }
        }
        
        // Update Charts Theme
        function updateChartsTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#ffffff' : '#2c3e50';
            const gridColor = isDark ? '#34495e' : '#ecf0f1';
            
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.options.plugins.legend.labels.color = textColor;
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.update();
                }
            });
        }
        
        // Update Charts with Data
        function updateCharts(data) {
            if (!data.history || data.history.length === 0) return;
            
            // Update CTR Chart
            if (charts.ctr) {
                const dates = data.history.map(h => h.date);
                const variants = Object.keys(data.history[0].allocations);
                
                charts.ctr.data.labels = dates;
                charts.ctr.data.datasets = variants.map((variant, index) => ({
                    label: variant,
                    data: data.history.map(h => (h.allocations[variant] * 100).toFixed(1)),
                    borderColor: index === 0 ? '#4a90e2' : '#5cb85c',
                    backgroundColor: index === 0 ? 'rgba(74, 144, 226, 0.1)' : 'rgba(92, 184, 92, 0.1)',
                    tension: 0.4
                }));
                charts.ctr.update();
            }
            
            // Update Allocation Chart
            if (charts.allocation) {
                const dates = data.history.slice(-7).map(h => h.date);
                const variants = Object.keys(data.history[0].allocations);
                
                charts.allocation.data.labels = dates;
                charts.allocation.data.datasets = variants.map((variant, index) => ({
                    label: variant,
                    data: data.history.slice(-7).map(h => (h.allocations[variant] * 100).toFixed(1)),
                    backgroundColor: index === 0 ? '#4a90e2' : '#5cb85c'
                }));
                charts.allocation.update();
            }
        }
        
        // Run Simulation
        function runSimulation() {
            const days = document.getElementById('sim-days').value;
            const impressions = document.getElementById('sim-impressions').value;
            const ctrControl = document.getElementById('sim-ctr-control').value;
            const ctrVariant = document.getElementById('sim-ctr-variant').value;
            
            // Show results
            document.getElementById('simulation-results').style.display = 'block';
            
            // Initialize simulation charts if not exists
            if (!charts.simAllocation) {
                const ctx = document.getElementById('simulation-allocation-chart');
                charts.simAllocation = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: days}, (_, i) => `Dia ${i + 1}`),
                        datasets: [
                            {
                                label: 'Control',
                                data: [],
                                borderColor: '#4a90e2',
                                tension: 0.4
                            },
                            {
                                label: 'Variant B',
                                data: [],
                                borderColor: '#5cb85c',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Simulate allocation evolution
            const allocations = [];
            let controlAlloc = 0.5;
            
            for (let i = 0; i < days; i++) {
                // Simple simulation logic
                const diff = (ctrVariant - ctrControl) / 100;
                controlAlloc = Math.max(0.2, Math.min(0.8, controlAlloc - diff * 0.02));
                allocations.push(controlAlloc);
            }
            
            charts.simAllocation.data.datasets[0].data = allocations.map(a => (a * 100).toFixed(1));
            charts.simAllocation.data.datasets[1].data = allocations.map(a => ((1 - a) * 100).toFixed(1));
            charts.simAllocation.update();
        }
        
        // Save Settings
        function saveSettings() {
            const settings = {
                min_explore_rate: document.getElementById('min-explore-rate').value,
                control_floor: document.getElementById('control-floor').value,
                max_daily_shift: document.getElementById('max-daily-shift').value
            };
            
            localStorage.setItem('bandit-settings', JSON.stringify(settings));
            showMessage('settings-message', '‚úÖ Configura√ß√µes salvas com sucesso!', 'success');
        }
        
        // Reset Data
        async function resetData() {
            if (!confirm('Tem certeza que deseja limpar todos os dados?')) return;
            
            try {
                const response = await fetch(`${API_URL}/reset_data`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Dados limpos com sucesso!');
                    location.reload();
                } else {
                    alert('‚ùå Erro ao limpar dados');
                }
            } catch (error) {
                alert(`‚ùå Erro de conex√£o: ${error.message}`);
            }
        }
        
        // Download Template
        function downloadTemplate() {
            window.open(`${API_URL}/download-template`, '_blank');
        }
        
        // Show Message
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
